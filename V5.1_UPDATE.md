# Worker v5.1 Update - Correct OpenAI API Format

## Problem Identified

The previous Worker v5.0 used an **invalid OpenAI Responses API format**:
```javascript
{
  type: "input_file",
  file: pdfBase64,
  mime_type: "application/pdf"
}
```

This caused OpenAI to:
- ❌ Silently ignore the PDF
- ❌ Return empty JSON
- ❌ Return empty debug.pages[]
- ❌ Not process pages
- ❌ Not extract exercises, nutrition, etc.

## Solution - Worker v5.1

### ✅ Correct OpenAI Responses API Format

```javascript
{
  type: "input_file",
  filename: "fitness-plan.pdf",
  file_data: "data:application/pdf;base64,<base64>"
}
```

### Key Changes

1. **Field name**: `file_data` (not `file`)
2. **Data format**: Must be data URI (`data:application/pdf;base64,<base64>`)
3. **Filename**: Optional but recommended
4. **Model**: Changed from `gpt-4.1-mini` to `gpt-4.1` (required for PDF support)
5. **Order**: File must come BEFORE instructions in content array

## Updated Worker Code

**File:** `cloudflare-worker.js`

**Changes:**
- ✅ Uses correct `input_file` format with `file_data`
- ✅ Converts base64 to data URI format
- ✅ Uses `gpt-4.1` model (supports PDFs)
- ✅ File comes before instructions in content array
- ✅ Accepts optional `filename` parameter

## Updated Backend

**Files:**
- `backend/src/services/worker.service.ts` - Now sends optional filename
- `backend/src/controllers/parse.controller.ts` - Passes filename to worker service

**Changes:**
- ✅ Sends filename to Worker (helps OpenAI with context)
- ✅ Worker service accepts optional filename parameter

## Testing

After deploying Worker v5.1, you should see:
- ✅ Complete debug.pages[] with all pages
- ✅ All exercises extracted
- ✅ All nutrition data extracted
- ✅ All sections populated
- ✅ No empty responses

## Deployment

1. Deploy updated `cloudflare-worker.js` to Cloudflare
2. Test with a sample PDF
3. Verify OpenAI processes all pages correctly
4. Check debug.pages[] contains all pages

